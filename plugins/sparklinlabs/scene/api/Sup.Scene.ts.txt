module Sup {

  var tmpVector3 = new SupEngine.THREE.Vector3();
  var tmpQuaternion = new SupEngine.THREE.Quaternion();

  export class Scene extends Asset {}

  export function loadScene(scenePathOrAsset) {
    player.gameInstance.destroyAllActors();
    appendScene(scenePathOrAsset);
  }

  export function appendScene(scenePathOrAsset, sceneParentActor=null, awakeActors=true) {
    var sceneAsset: Scene;

    if (typeof scenePathOrAsset === 'string') {
      var entry = player.entriesByPath[scenePathOrAsset];
      if (entry == null) throw new Error(`Invalid asset path: ${scenePathOrAsset}`);

      var outerAsset = player.getOuterAsset(entry.id);
      if (outerAsset.type != 'scene') throw new Error(`Invalid asset type: got ${outerAsset.type}, expected scene`);
      sceneAsset = <Scene>outerAsset;
    } else {
      sceneAsset = <Scene>scenePathOrAsset;
    }

    let walk = (node, parentActor) => {
      let actor: Actor;
      let isPrefab = (node.components[0] != null && node.components[0].type === "Prefab");
      if (isPrefab) {
        let prefabAsset = player.getOuterAsset(node.components[0].config.sceneAssetId);
        if (prefabAsset != null) {
          actor = appendScene(prefabAsset, parentActor, false)[0];
          actor.__inner.name = node.name;

          actor.__inner.setLocalPosition( tmpVector3.set(node.position.x, node.position.y, node.position.z) )
          actor.__inner.setLocalOrientation( tmpQuaternion.set(node.orientation.x, node.orientation.y, node.orientation.z, node.orientation.w) )
          actor.__inner.setLocalScale( tmpVector3.set(node.scale.x, node.scale.y, node.scale.z) )
        } else throw new Error(`Undefined prefab in ${sceneAsset.name}`);

      } else {
        actor = player.createActor(node.name, parentActor);

        actor.__inner.setLocalPosition( tmpVector3.set(node.position.x, node.position.y, node.position.z) )
        actor.__inner.setLocalOrientation( tmpQuaternion.set(node.orientation.x, node.orientation.y, node.orientation.z, node.orientation.w) )
        actor.__inner.setLocalScale( tmpVector3.set(node.scale.x, node.scale.y, node.scale.z) )

        node.components.forEach( (sceneComponent) => {
          allComponents.push({
            sceneComponent: sceneComponent,
            actorComponent: player.createComponent(sceneComponent.type, actor, sceneComponent.config)
          });
        });

        node.children.forEach( (child) => { walk(child, actor); } );
      }

      return actor;
    }

    function awakeActor(actor) {
      actor.__inner.awake();
      actor.getChildren().forEach( (child) => { awakeActor(child); } )
    }

    var actors: Actor[] = [];
    var allComponents = [];
    sceneAsset.__inner.nodes.forEach( (node) => { actors.push( walk(node, sceneParentActor) ); } );

    allComponents.forEach((x) => {
      SupRuntime.plugins[x.sceneComponent.type].setupComponent(player, x.actorComponent.__inner, x.sceneComponent.config);
    });

    if (awakeActors) actors.forEach( (actor) => { awakeActor(actor); });

    return actors;
  }
}
